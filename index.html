<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Status - Bcred Consultoria</title>
  
  <!-- Firebase SDK (Versão Modular v9) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { 
      getFirestore,
      collection,
      addDoc,
      getDocs,
      updateDoc,
      deleteDoc,
      doc,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyATpi0m0pN-aA1dxDqNX2vJLqQgV_ypvrA",
      authDomain: "bcredconsultoria-641d5.firebaseapp.com",
      projectId: "bcredconsultoria-641d5",
      storageBucket: "bcredconsultoria-641d5.appspot.com",
      messagingSenderId: "182320069073",
      appId: "1:182320069073:web:635bbbbc0f55b3348888f0"
    };

    // Inicialização do Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Exportar para escopo global
    window.db = db;
    window.auth = auth;
    window.firebaseTools = {
      firestore: { collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where },
      auth: { signInWithEmailAndPassword, signOut, onAuthStateChanged }
    };
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
      color: #333;
    }
    header {
      background: #0073e6;
      color: white;
      text-align: center;
      padding: 50px 20px;
    }
    header h1 {
      font-size: 36px;
      margin: 0;
    }
    header p {
      font-size: 18px;
      margin-top: 10px;
    }
    .login-section, .admin-login-section {
      background: #ffffff;
      padding: 40px 20px;
      max-width: 400px;
      margin: -50px auto 0;
      border-radius: 10px;
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    .login-section input, .admin-login-section input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }
    .login-section button, .admin-login-section button {
      width: 100%;
      padding: 12px;
      background-color: #0073e6;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 18px;
      cursor: pointer;
    }
    .login-section button:hover, .admin-login-section button:hover {
      background-color: #005bb5;
    }
    .dashboard {
      display: none;
      background: #ffffff;
      padding: 40px 20px;
      max-width: 600px;
      margin: 40px auto 0;
      border-radius: 10px;
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
      text-align: left;
    }
    .dashboard h2 {
      font-size: 28px;
      color: #0073e6;
      margin-bottom: 20px;
    }
    .dashboard p {
      font-size: 16px;
      margin: 8px 0;
    }
    .status {
      font-weight: bold;
      font-size: 18px;
      margin-top: 20px;
    }
    .logout-button {
      display: block;
      width: 100%;
      padding: 12px;
      margin-top: 20px;
      background-color: #ff5722;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 18px;
      text-align: center;
      cursor: pointer;
    }
    .logout-button:hover {
      background-color: #e64a19;
    }
    .admin-dashboard {
      display: none;
      background: #ffffff;
      padding: 40px 20px;
      max-width: 800px;
      margin: 40px auto 0;
      border-radius: 10px;
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
      text-align: left;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #f0f0f0;
    }
    .add-client-form {
      margin-top: 20px;
      padding: 20px;
      background-color: #f9f9f9;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    footer {
      background: #0073e6;
      color: white;
      text-align: center;
      padding: 20px;
      margin-top: 40px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Painel de Status de Empréstimo</h1>
    <p>Acompanhe o status do seu empréstimo com a Bcred Consultoria</p>
  </header>

  <!-- Login Cliente -->
  <div class="login-section" id="loginSection">
    <h2>Login do Cliente</h2>
    <input type="text" id="username" placeholder="CPF (somente números)" maxlength="11">
    <input type="password" id="password" placeholder="Senha">
    <button onclick="loginCliente()">Entrar</button>
    <p style="margin-top:20px">
      <a href="#" onclick="showAdminLogin()">Acesso Administrador</a>
    </p>
  </div>

  <!-- Painel Cliente -->
  <div class="dashboard" id="dashboard">
    <h2>Status do Empréstimo</h2>
    <p><strong>Nome:</strong> <span id="clientName"></span></p>
    <p><strong>Valor do Empréstimo:</strong> <span id="loanAmount"></span></p>
    <p><strong>Número de Parcelas:</strong> <span id="installments"></span></p>
    <p><strong>Valor da Parcela:</strong> <span id="monthlyPayment"></span></p>
    <p class="status"><strong>Status:</strong> <span id="loanStatus"></span></p>
    <button class="logout-button" onclick="logout()">Sair</button>
  </div>

  <!-- Login Admin -->
  <div class="admin-login-section" id="adminLoginSection" style="display:none">
    <h2>Login Administrador</h2>
    <input type="text" id="adminEmail" placeholder="Email administrativo">
    <input type="password" id="adminPassword" placeholder="Senha">
    <button onclick="loginAdmin()">Entrar</button>
    <p style="margin-top:20px">
      <a href="#" onclick="showClientLogin()">Voltar ao Cliente</a>
    </p>
  </div>

  <!-- Painel Admin -->
  <div class="admin-dashboard" id="adminDashboard">
    <h2>Painel Administrativo</h2>
    
    <div class="add-client-form">
      <h3>Novo Cliente</h3>
      <input type="text" id="newCpf" placeholder="CPF" maxlength="11">
      <input type="text" id="newName" placeholder="Nome Completo">
      <input type="number" id="newLoanAmount" placeholder="Valor do Empréstimo">
      <input type="number" id="newInstallments" placeholder="Parcelas">
      <input type="password" id="newPassword" placeholder="Senha">
      <select id="newStatus">
        <option value="Aprovado">Aprovado</option>
        <option value="Em Análise">Em Análise</option>
        <option value="Reprovado">Reprovado</option>
      </select>
      <button onclick="addCliente()">Adicionar Cliente</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>CPF</th>
          <th>Nome</th>
          <th>Valor</th>
          <th>Parcelas</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="clientList"></tbody>
    </table>
    <button class="logout-button" onclick="logoutAdmin()">Sair</button>
  </div>

  <footer>
    <p>&copy; 2023 Bcred Consultoria. Todos os direitos reservados.</p>
  </footer>

  <script>
    // Função para formatação de moeda
    function formatarMoeda(valor) {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(valor);
    }

    // Controle de Login do Cliente
    async function loginCliente() {
      const cpf = document.getElementById('username').value.replace(/\D/g, '');
      const senha = document.getElementById('password').value;

      try {
        const q = firebaseTools.firestore.query(
          firebaseTools.firestore.collection(db, 'clientes'),
          firebaseTools.firestore.where('cpf', '==', cpf),
          firebaseTools.firestore.where('senha', '==', senha)
        );
        
        const snapshot = await firebaseTools.firestore.getDocs(q);

        if (!snapshot.empty) {
          const cliente = snapshot.docs[0].data();
          exibirPainelCliente(cliente);
        } else {
          alert('Credenciais inválidas');
        }
      } catch (error) {
        alert('Erro ao fazer login');
        console.error(error);
      }
    }

    function exibirPainelCliente(cliente) {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      
      document.getElementById('clientName').textContent = cliente.nome;
      document.getElementById('loanAmount').textContent = formatarMoeda(cliente.valor);
      document.getElementById('installments').textContent = `${cliente.parcelas}x`;
      document.getElementById('monthlyPayment').textContent = formatarMoeda(cliente.valorParcela);
      document.getElementById('loanStatus').textContent = cliente.status;
    }

    // Controle de Login do Administrador
    async function loginAdmin() {
      const email = document.getElementById('adminEmail').value;
      const senha = document.getElementById('adminPassword').value;

      try {
        await firebaseTools.auth.signInWithEmailAndPassword(auth, email, senha);
        document.getElementById('adminLoginSection').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'block';
        carregarClientes();
      } catch (error) {
        alert('Credenciais inválidas: ' + error.message);
      }
    }

    // Função para adicionar cliente (corrigida)
    async function addCliente() {
      const novoCliente = {
        cpf: document.getElementById('newCpf').value.replace(/\D/g, ''),
        nome: document.getElementById('newName').value.trim(),
        valor: parseFloat(document.getElementById('newLoanAmount').value),
        parcelas: parseInt(document.getElementById('newInstallments').value),
        senha: document.getElementById('newPassword').value.trim(),
        status: document.getElementById('newStatus').value,
        valorParcela: parseFloat(document.getElementById('newLoanAmount').value) / 
                      parseInt(document.getElementById('newInstallments').value)
      };

      // Validação
      if (!novoCliente.cpf || !novoCliente.nome || isNaN(novoCliente.valor) || 
          isNaN(novoCliente.parcelas) || !novoCliente.senha) {
        alert('Preencha todos os campos corretamente!');
        return;
      }

      try {
        await firebaseTools.firestore.addDoc(
          firebaseTools.firestore.collection(db, 'clientes'),
          novoCliente
        );
        carregarClientes();
        // Limpar os campos do formulário manualmente
        document.getElementById('newCpf').value = '';
        document.getElementById('newName').value = '';
        document.getElementById('newLoanAmount').value = '';
        document.getElementById('newInstallments').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('newStatus').selectedIndex = 0;
        alert('Cliente adicionado com sucesso!');
      } catch (error) {
        console.error('Erro ao adicionar cliente:', error);
        alert('Erro ao adicionar cliente: ' + error.message);
      }
    }

    // Função para carregar clientes
    async function carregarClientes() {
      const tbody = document.getElementById('clientList');
      tbody.innerHTML = '';

      try {
        const querySnapshot = await firebaseTools.firestore.getDocs(
          firebaseTools.firestore.collection(db, 'clientes')
        );

        querySnapshot.forEach((doc) => {
          const cliente = doc.data();
          tbody.innerHTML += `
            <tr>
              <td>${cliente.cpf}</td>
              <td>${cliente.nome}</td>
              <td>${formatarMoeda(cliente.valor)}</td>
              <td>${cliente.parcelas}x</td>
              <td>
                <select onchange="atualizarStatus('${doc.id}', this.value)">
                  <option ${cliente.status === 'Aprovado' ? 'selected' : ''}>Aprovado</option>
                  <option ${cliente.status === 'Em Análise' ? 'selected' : ''}>Em Análise</option>
                  <option ${cliente.status === 'Reprovado' ? 'selected' : ''}>Reprovado</option>
                </select>
              </td>
              <td>
                <button onclick="excluirCliente('${doc.id}')">Excluir</button>
              </td>
            </tr>
          `;
        });
      } catch (error) {
        console.error('Erro ao carregar clientes:', error);
      }
    }

    // Função para atualizar status
    async function atualizarStatus(id, novoStatus) {
      try {
        await firebaseTools.firestore.updateDoc(
          firebaseTools.firestore.doc(db, 'clientes', id),
          { status: novoStatus }
        );
        carregarClientes();
      } catch (error) {
        console.error('Erro ao atualizar status:', error);
      }
    }

    // Função para excluir cliente
    async function excluirCliente(id) {
      if (confirm('Confirmar exclusão?')) {
        try {
          await firebaseTools.firestore.deleteDoc(
            firebaseTools.firestore.doc(db, 'clientes', id)
          );
          carregarClientes();
        } catch (error) {
          console.error('Erro ao excluir cliente:', error);
        }
      }
    }

    // Controle de Sessão
    firebaseTools.auth.onAuthStateChanged(auth, (usuario) => {
      if (usuario) {
        document.getElementById('adminDashboard').style.display = 'block';
        document.getElementById('loginSection').style.display = 'none';
        carregarClientes();
      } else {
        document.getElementById('adminDashboard').style.display = 'none';
        document.getElementById('loginSection').style.display = 'block';
      }
    });

    // Funções Auxiliares
    function showAdminLogin() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('adminLoginSection').style.display = 'block';
    }

    function showClientLogin() {
      document.getElementById('adminLoginSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
    }

    function logout() {
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
    }

    async function logoutAdmin() {
      try {
        await firebaseTools.auth.signOut(auth);
        alert('Você saiu do painel administrativo.');
      } catch (error) {
        alert('Erro ao sair: ' + error.message);
      }
    }
  </script>
</body>
</html>
