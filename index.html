<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Status - Bcred Consultoria</title>
    
    <!-- Firebase SDK (Versão Modular v9) -->
    <script type="module">
        import { 
            initializeApp, 
            getAuth, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            updateDoc, 
            deleteDoc, 
            doc, 
            query, 
            where 
        } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyATpi0m0pN-aA1dxDqNX2vJLqQgV_ypvrA",
            authDomain: "bcredconsultoria-641d5.firebaseapp.com",
            projectId: "bcredconsultoria-641d5",
            storageBucket: "bcredconsultoria-641d5.appspot.com",
            messagingSenderId: "182320069073",
            appId: "1:182320069073:web:635bbbbc0f55b3348888f0"
        };

        // Inicialização
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Exportar para escopo global
        window.auth = auth;
        window.db = db;
        window.firebase = {
            authFunctions: { signInWithEmailAndPassword, signOut, onAuthStateChanged },
            firestoreFunctions: { collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where }
        };
    </script>

    <!-- O CSS permanece igual ao anterior -->

</head>
<body>
    <!-- Estrutura HTML mantida igual à anterior -->

    <script>
        // Função corrigida para adicionar clientes
        async function addCliente() {
            // Validação dos campos
            const cpf = document.getElementById('newCpf').value.replace(/\D/g, '');
            const nome = document.getElementById('newName').value.trim();
            const valor = parseFloat(document.getElementById('newLoanAmount').value);
            const parcelas = parseInt(document.getElementById('newInstallments').value);
            const senha = document.getElementById('newPassword').value.trim();
            const status = document.getElementById('newStatus').value;

            if (!cpf || !nome || isNaN(valor) || isNaN(parcelas) || !senha) {
                alert("Preencha todos os campos corretamente!");
                return;
            }

            try {
                // Cálculo da parcela
                const valorParcela = valor / parcelas;
                
                // Uso correto da função addDoc
                await firebase.firestoreFunctions.addDoc(
                    firebase.firestoreFunctions.collection(db, 'clientes'), 
                    {
                        cpf,
                        nome,
                        valor,
                        parcelas,
                        senha,
                        status,
                        valorParcela
                    }
                );

                // Atualização da lista e feedback
                carregarClientes();
                document.querySelector('.add-client-form').reset();
                alert('Cliente adicionado com sucesso!');
                
            } catch (error) {
                console.error("Erro detalhado:", error);
                alert(`Erro ao adicionar cliente: ${error.message}`);
            }
        }

        // Função corrigida para carregar clientes
        async function carregarClientes() {
            const tbody = document.getElementById('clientList');
            tbody.innerHTML = '';

            try {
                const querySnapshot = await firebase.firestoreFunctions.getDocs(
                    firebase.firestoreFunctions.collection(db, 'clientes')
                );

                querySnapshot.forEach((doc) => {
                    const cliente = doc.data();
                    tbody.innerHTML += `
                        <tr>
                            <td>${cliente.cpf}</td>
                            <td>${cliente.nome}</td>
                            <td>${formatarMoeda(cliente.valor)}</td>
                            <td>${cliente.parcelas}x</td>
                            <td>
                                <select onchange="atualizarStatus('${doc.id}', this.value)">
                                    <option ${cliente.status === 'Aprovado' ? 'selected' : ''}>Aprovado</option>
                                    <option ${cliente.status === 'Em Análise' ? 'selected' : ''}>Em Análise</option>
                                    <option ${cliente.status === 'Reprovado' ? 'selected' : ''}>Reprovado</option>
                                </select>
                            </td>
                            <td>
                                <button onclick="excluirCliente('${doc.id}')">Excluir</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Erro ao carregar clientes:", error);
            }
        }

        // Função corrigida para atualizar status
        async function atualizarStatus(id, novoStatus) {
            try {
                await firebase.firestoreFunctions.updateDoc(
                    firebase.firestoreFunctions.doc(db, 'clientes', id), 
                    { status: novoStatus }
                );
                carregarClientes();
            } catch (error) {
                console.error("Erro ao atualizar status:", error);
            }
        }

        // Demais funções mantidas com ajustes similares
    </script>
</body>
</html>
